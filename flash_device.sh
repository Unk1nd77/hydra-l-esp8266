#!/bin/bash

# –°–∫—Ä–∏–ø—Ç "–≤—Å–µ –≤ –æ–¥–Ω–æ–º" –¥–ª—è –ø—Ä–æ—à–∏–≤–∫–∏ Hydra-L —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
# –ê–≤—Ç–æ—Ä: Kiro AI Assistant

set -e

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}"
echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "‚ïë                    HYDRA-L FLASH TOOL                       ‚ïë"
echo "‚ïë              –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ—à–∏–≤–∫–∞ ESP8266                ‚ïë"
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo -e "${NC}"

# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
if [[ "$OSTYPE" == "darwin"* ]]; then
    OS="macOS"
    SERIAL_PATTERN="/dev/cu.*"
elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
    OS="Linux"
    SERIAL_PATTERN="/dev/ttyUSB* /dev/ttyACM*"
else
    echo -e "${RED}‚ùå –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–∞—è –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞${NC}"
    exit 1
fi

echo -e "${GREEN}‚úì –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞: $OS${NC}"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ ESP8266 —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
find_esp_device() {
    echo -e "${YELLOW}üîç –ü–æ–∏—Å–∫ ESP8266 —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞...${NC}"
    
    if [[ "$OS" == "macOS" ]]; then
        DEVICES=$(ls /dev/cu.* 2>/dev/null | grep -E "(usbserial|wchusbserial)" | head -1)
    else
        DEVICES=$(ls /dev/ttyUSB* /dev/ttyACM* 2>/dev/null | head -1)
    fi
    
    if [ -z "$DEVICES" ]; then
        echo -e "${RED}‚ùå ESP8266 —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!${NC}"
        echo
        echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:"
        echo "1. USB –∫–∞–±–µ–ª—å –ø–æ–¥–∫–ª—é—á–µ–Ω"
        echo "2. –î—Ä–∞–π–≤–µ—Ä—ã CH340/CP2102 —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
        echo "3. –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤–∫–ª—é—á–µ–Ω–æ"
        echo
        if [[ "$OS" == "macOS" ]]; then
            echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ—Ä—Ç—ã:"
            ls /dev/cu.* 2>/dev/null || echo "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–æ—Ä—Ç–æ–≤"
        else
            echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ—Ä—Ç—ã:"
            ls /dev/ttyUSB* /dev/ttyACM* 2>/dev/null || echo "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–æ—Ä—Ç–æ–≤"
        fi
        exit 1
    fi
    
    echo -e "${GREEN}‚úì –ù–∞–π–¥–µ–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: $DEVICES${NC}"
    ESP_PORT="$DEVICES"
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
check_environment() {
    echo -e "${YELLOW}üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏...${NC}"
    
    if [ -z "$IDF_PATH" ]; then
        echo -e "${YELLOW}‚ö† –û–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ. –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º...${NC}"
        if [ -f "$HOME/esp/setup_env.sh" ]; then
            source "$HOME/esp/setup_env.sh"
        else
            echo -e "${RED}‚ùå –û–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!${NC}"
            echo "–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
            if [[ "$OS" == "macOS" ]]; then
                echo "./install_macos.sh"
            else
                echo "./install_linux.sh"
            fi
            exit 1
        fi
    fi
    
    if ! command -v xtensa-lx106-elf-gcc &> /dev/null; then
        echo -e "${RED}‚ùå ESP8266 toolchain –Ω–µ –Ω–∞–π–¥–µ–Ω!${NC}"
        echo "–í—ã–ø–æ–ª–Ω–∏—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∫—É –æ–∫—Ä—É–∂–µ–Ω–∏—è"
        exit 1
    fi
    
    echo -e "${GREEN}‚úì –û–∫—Ä—É–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ${NC}"
}

# –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
build_project() {
    echo -e "${YELLOW}üî® –°–±–æ—Ä–∫–∞ –ø—Ä–æ—à–∏–≤–∫–∏...${NC}"
    
    if [ ! -f "./build.sh" ]; then
        echo -e "${RED}‚ùå –°–∫—Ä–∏–ø—Ç —Å–±–æ—Ä–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω!${NC}"
        echo "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞"
        exit 1
    fi
    
    ./build.sh
    
    if [ ! -f "build/hydra_l.bin" ]; then
        echo -e "${RED}‚ùå –°–±–æ—Ä–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å!${NC}"
        exit 1
    fi
    
    echo -e "${GREEN}‚úì –ü—Ä–æ—à–∏–≤–∫–∞ —Å–æ–±—Ä–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ${NC}"
}

# –ü—Ä–æ—à–∏–≤–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
flash_device() {
    echo -e "${YELLOW}üì± –ü—Ä–æ—à–∏–≤–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞...${NC}"
    echo "–ü–æ—Ä—Ç: $ESP_PORT"
    echo
    
    python3 $IDF_PATH/tools/idf.py -p "$ESP_PORT" flash
    
    if [ $? -eq 0 ]; then
        echo
        echo -e "${GREEN}üéâ –ü–†–û–®–ò–í–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê –£–°–ü–ï–®–ù–û! üéâ${NC}"
        echo
        echo "–í–∞—à–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≥–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ:"
        echo "‚Ä¢ WiFi —Å–µ—Ç—å: Hydra-L (–ø–∞—Ä–æ–ª—å: 12345678)"
        echo "‚Ä¢ –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: http://192.168.4.1"
        echo "‚Ä¢ API –¥–∞–Ω–Ω—ã—Ö: http://192.168.4.1/getData"
        echo
        
        read -p "–ó–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Serial –ø–æ—Ä—Ç–∞? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            echo -e "${BLUE}–ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (Ctrl+] –¥–ª—è –≤—ã—Ö–æ–¥–∞)...${NC}"
            python3 $IDF_PATH/tools/idf.py -p "$ESP_PORT" monitor
        fi
    else
        echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ—à–∏–≤–∫–∏!${NC}"
        exit 1
    fi
}

# –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
main() {
    echo "–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:"
    echo "1. –ù–∞–π–¥–µ—Ç –≤–∞—à–µ ESP8266 —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ"
    echo "2. –°–æ–±–µ—Ä–µ—Ç –ø—Ä–æ—à–∏–≤–∫—É"
    echo "3. –ü—Ä–æ—à—å–µ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ"
    echo
    read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (Y/n): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Nn]$ ]]; then
        echo "–û—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"
        exit 0
    fi
    
    find_esp_device
    check_environment
    build_project
    flash_device
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω –∏–∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "main/main.c" ] || [ ! -f "CMakeLists.txt" ]; then
    echo -e "${RED}‚ùå –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞ hydra-l-esp8266${NC}"
    exit 1
fi

# –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
main